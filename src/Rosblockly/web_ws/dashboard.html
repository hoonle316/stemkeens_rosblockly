<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ROS Web Dashboard</title>
    <link rel="icon" href="https://i.ibb.co/k6zJ4sb/favicon-32x32.png" type="image/x-icon">
    <!-- Blockly ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://unpkg.com/blockly@10.0.0/blockly.min.js"></script>
    <!-- Blockly JavaScript ÏÉùÏÑ±Í∏∞ Ï∂îÍ∞Ä -->
    <script src="https://unpkg.com/blockly@10.0.0/javascript.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <style>
        /* Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        }

        .navbar {
            background-color: #f0d6a3;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: #333;
            font-weight: bold;
        }

        .navbar .logo {
            display: flex;
            align-items: center;
        }

        .navbar img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }

        .navbar .title {
            font-size: 20px;
        }

        .navbar .buttons {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }

        .buttons .btn {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }

        .btn.red {
            background-color: #dc3545;
        }

        .btn span {
            margin-left: 5px;
        }

        #mainContent {
            display: flex;
            height: calc(100vh - 60px);
        }

        #blocklyDiv {
            height: 100%;
            width: 50%;
            border-right: 1px solid #ccc;
        }

        #previewDiv {
            height: 100%;
            width: 50%;
            position: relative;
            overflow: hidden; /* Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        }

        #simulationFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        #codeContainer {
            display: none;
            padding: 10px;
            background-color: white;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            z-index: 10;
        }

        #codeDiv {
            width: 100%;
            height: calc(100% - 50px);
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        #codeContainer h2 {
            margin-top: 0;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: #333;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div class="logo">
            <img src="https://i.ibb.co/CnbdrQh/Frame-1895.png" alt="Logo">
            <span class="title">Stemkeens Rosblockly</span>
        </div>
        <div class="buttons">
            <div class="btn red" onclick="exportToROS()" title="Export to ROS">
                üöÄ <span>Export to ROS</span>
            </div>
            <div class="btn" onclick="showCode()" title="Show Code">
                üíª <span>Code</span>
            </div>
            <div class="btn" onclick="sendURDFToSimulation()" title="Send to Simulation">
                üñ•Ô∏è <span>Send to Simulation</span>
            </div>
        </div>
    </div>

    <div id="mainContent">
        <div id="blocklyDiv"></div>

        <div id="previewDiv">
            <div id="container"></div>
            <iframe id="simulationFrame" src="simulation.html"></iframe>

            <div id="codeContainer">
                <span class="close-btn" onclick="closeCode()">&times;</span>
                <h2>Generated URDF Code</h2>
                <div id="codeDiv"></div>
            </div>
        </div>
    </div>

    <!-- Ïä§ÌÅ¨Î¶ΩÌä∏Î•º body ÎÅùÎ∂ÄÎ∂ÑÏóê ÏúÑÏπòÏãúÏºú DOMÏù¥ Î°úÎìúÎêú ÌõÑ Ïã§ÌñâÎêòÎèÑÎ°ù Ìï©ÎãàÎã§. -->
    <script>
    let simulationWindow = null;

        // ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÏÉùÏÑ± (ÏÉùÏÑ±Í∏∞ Ï†ïÏùò ÌõÑ)
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: `<xml>
                <category name="World Link" colour="#1E88E5">
                    <block type="world_link"></block>
                </category>
                <category name="Link" colour="#43A047">
                    <block type="link"></block>
                    <block type="origin"></block>
                    <block type="material"></block>
                </category>
                <category name="Joint" colour="#FB8C00">
                    <block type="joint"></block>
                    <block type="axis"></block>
                    <block type="limit"></block>
                </category>        
                <category name="Geometry" colour="#8E24AA">
                    <block type="box"></block>
                    <block type="sphere"></block>
                    <block type="cylinder"></block>
                </category>
                <category name="Basic Blocks" colour="#757575">
                    <block type="start"></block>
                </category>
                <category name="ROS2 Control" colour="#FF5722">
                    <block type="controller"></block>
                    <block type="controller_parameters"></block>
                    <block type="hardware_interface"></block>
                    <block type="transmission"></block>
                    <block type="joint_limits"></block>
                </category>
                <category name="Gazebo Plugins" colour="#FFAA00">
                    <block type="camera_plugin"></block>
                </category>
            </xml>`
        });
    
        // Î∏îÎ°ù Ï†ïÏùò
        Blockly.defineBlocksWithJsonArray([
            {
                "type": "start",
                "message0": "start",
                "nextStatement": null,
                "colour": 330,
                "tooltip": "The starting point of the block. Automatically adds a world link.",
                "helpUrl": ""
            },
            {
                "type": "world_link",
                "message0": "World Link (Fixed) %1",
                "args0": [
                    { "type": "field_input", "name": "LINK_NAME", "text": "world" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 210,
                "tooltip": "Defines the root fixed link (World Link). No shapes allowed.",
                "helpUrl": ""
            },
            {
                "type": "link",
                "message0": "Link %1",
                "args0": [
                    { "type": "field_input", "name": "LINK_NAME", "text": "link_name" }
                ],
                "message1": "Add shape %1",
                "args1": [
                    { "type": "input_statement", "name": "SHAPE" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 120,
                "tooltip": "Defines a link with an optional shape.",
                "helpUrl": ""
            },
            {
                "type": "joint",
                "message0": "Joint %1 to %2",
                "args0": [
                    { "type": "field_input", "name": "PARENT_LINK", "text": "parent_link" },
                    { "type": "field_input", "name": "CHILD_LINK", "text": "child_link" }
                ],
                "message1": "Joint type %1",
                "args1": [
                    {
                        "type": "field_dropdown",
                        "name": "JOINT_TYPE",
                        "options": [
                            ["Fixed", "fixed"],
                            ["Revolute", "revolute"],
                            ["Prismatic", "prismatic"],
                            ["Continuous", "continuous"]
                        ]
                    }
                ],
                "message2": "Add joint elements %1",
                "args2": [
                    {"type": "input_statement", "name": "JOINT_ELEMENTS"}
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Defines a joint connecting two links with a specified type.",
                "helpUrl": ""
            },
            {
                "type": "box",
                "message0": "Box with length %1 width %2 height %3",
                "args0": [
                    { "type": "field_number", "name": "LENGTH", "value": 1, "min": 0 },
                    { "type": "field_number", "name": "WIDTH", "value": 1, "min": 0 },
                    { "type": "field_number", "name": "HEIGHT", "value": 1, "min": 0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Defines a Box with specified dimensions",
                "helpUrl": ""
            },
            {
                "type": "sphere",
                "message0": "Sphere with radius %1",
                "args0": [
                    { "type": "field_number", "name": "RADIUS", "value": 1, "min": 0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Defines a Sphere with specified radius",
                "helpUrl": ""
            },
            {
                "type": "cylinder", 
                "message0": "Cylinder with radius %1 height %2",
                "args0": [
                    { "type": "field_number", "name": "RADIUS", "value": 1, "min": 0 },
                    { "type": "field_number", "name": "HEIGHT", "value": 1, "min": 0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Defines a Cylinder with specified dimensions",
                "helpUrl": ""
            },
            {
                "type": "material",
                "message0": "Color RGBA %1 %2 %3 %4",
                "args0": [
                    {"type": "field_number", "name":"R", "value":0.5, "min":0,"max":1},
                    {"type": "field_number", "name":"G", "value":0.5, "min":0,"max":1},
                    {"type": "field_number", "name":"B", "value":0.5, "min":0,"max":1},
                    {"type": "field_number", "name":"A", "value":1.0, "min":0,"max":1},
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300,
                "tooltip": "Setting a Material",
                "helpUrl": ""
            },
            {
                "type": "origin",
                "message0": "Origin x %1 y %2 z %3 r %4 p %5 y %6",
                "args0": [
                    {"type": "field_number", "name": "X", "value": 0},
                    {"type": "field_number", "name": "Y", "value": 0},
                    {"type": "field_number", "name": "Z", "value": 0},
                    {"type": "field_number", "name": "R", "value": 0},
                    {"type": "field_number", "name": "P", "value": 0},
                    {"type": "field_number", "name": "YAW", "value": 0},
                ],
                "previousStatement": null,
                "nextStatement": null, 
                "colour": 180,
                "tooltip": "Set the origin position and rotation.",
                "helpUrl": ""
            },
            {
                "type": "axis",
                "message0": "Axis x %1 y %2 z %3",
                "args0": [
                { "type": "field_number", "name": "X", "value": 0 },
                { "type": "field_number", "name": "Y", "value": 0 },
                { "type": "field_number", "name": "Z", "value": 1 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 200,
                "tooltip": "Sets the axis of rotation or movement for the joint.",
                "helpUrl": ""
            },
            {
                "type": "limit",
                "message0": "lower %1 upper %2 effort %3 velocity %4",
                "args0": [
                { "type": "field_number", "name": "LOWER", "value": -1.57 },
                { "type": "field_number", "name": "UPPER", "value": 1.57 },
                { "type": "field_number", "name": "EFFORT", "value": 1.0 },
                { "type": "field_number", "name": "VELOCITY", "value": 1.0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 0,
                "tooltip": "Set the motion limits of the joint.",
                "helpUrl": ""
            },
            {
                "type": "controller",
                "message0": "Controller %1",
                "args0": [
                    { "type": "field_input", "name": "CONTROLLER_NAME", "text": "controller_name" }
                ],
                "message1": "Type %1",
                "args1": [
                    {
                        "type": "field_dropdown",
                        "name": "CONTROLLER_TYPE",
                        "options": [
                            ["trajectory_controller", "trajectory_controller"],
                            ["position_controller", "position_controller"],
                            ["velocity_controller", "velocity_controller"],
                            ["effort_controller", "effort_controller"]
                        ]
                    }
                ],
                "message2": "Joints %1",
                "args2": [
                    { "type": "input_statement", "name": "JOINTS" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 160,
                "tooltip": "Defines a controller with specified type and joints.",
                "helpUrl": ""
            },
            {
                "type": "joint_list",
                "message0": "Joint %1",
                "args0": [
                    { "type": "field_input", "name": "JOINT_NAME", "text": "joint_name" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 120,
                "tooltip": "Specifies a joint to be controlled.",
                "helpUrl": ""
            },

            {
                "type": "hardware_interface",
                "message0": "Joint %1 Interface %2",
                "args0": [
                    { "type": "field_input", "name": "JOINT_NAME", "text": "joint_name" },
                    {
                        "type": "field_dropdown",
                        "name": "INTERFACE_TYPE",
                        "options": [
                            ["PositionJointInterface", "PositionJointInterface"],
                            ["VelocityJointInterface", "VelocityJointInterface"],
                            ["EffortJointInterface", "EffortJointInterface"],
                            ["JointStateInterface", "JointStateInterface"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 230,
                "tooltip": "Defines the hardware interface for a joint.",
                "helpUrl": ""
            },
            {
                "type": "controller_parameters",
                "message0": "Controller Parameters for %1",
                "args0": [
                    { "type": "field_input", "name": "CONTROLLER_NAME", "text": "controller_name" }
                ],
                "message1": "Sampling Time %1",
                "args1": [
                    { "type": "field_number", "name": "SAMPLING_TIME", "value": 0.1 }
                ],
                "message2": "PID Values: P %1 I %2 D %3",
                "args2": [
                    { "type": "field_number", "name": "P_GAIN", "value": 1.0 },
                    { "type": "field_number", "name": "I_GAIN", "value": 0.0 },
                    { "type": "field_number", "name": "D_GAIN", "value": 0.1 }
                ],
                "message3": "Update Rate %1",
                "args3": [
                    { "type": "field_number", "name": "UPDATE_RATE", "value": 100 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 200,
                "tooltip": "Defines controller parameters such as sampling time, PID values, and update rate.",
                "helpUrl": ""
            },
            {
                "type": "transmission",
                "message0": "Transmission for %1",
                "args0": [
                    { "type": "field_input", "name": "TRANSMISSION_NAME", "text": "transmission_name" }
                ],
                "message1": "Joint Name %1",
                "args1": [
                    { "type": "field_input", "name": "JOINT_NAME", "text": "joint_name" }
                ],
                "message2": "Mechanical Reduction %1",
                "args2": [
                    { "type": "field_number", "name": "MECHANICAL_REDUCTION", "value": 1 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 180,
                "tooltip": "Defines transmission with mechanical reduction for a joint.",
                "helpUrl": ""
            },
            {
                "type": "joint_limits",
                "message0": "Joint Limits for %1",
                "args0": [
                    { "type": "field_input", "name": "JOINT_NAME", "text": "joint_name" }
                ],
                "message1": "Position: Lower %1 Upper %2",
                "args1": [
                    { "type": "field_number", "name": "LOWER", "value": -1.57 },
                    { "type": "field_number", "name": "UPPER", "value": 1.57 }
                ],
                "message2": "Effort %1 Velocity %2",
                "args2": [
                    { "type": "field_number", "name": "EFFORT", "value": 1.0 },
                    { "type": "field_number", "name": "VELOCITY", "value": 1.0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 0,
                "tooltip": "Defines the physical limits of a joint including position, effort, and velocity.",
                "helpUrl": ""
            },
            {
                "type": "camera_plugin",
                "message0": "Camera Plugin",
                "message1": "Name: %1",
                "args1": [
                { "type": "field_input", "name": "PLUGIN_NAME", "text": "camera_controller" }
                ],
                "message2": "Update Rate: %1",
                "args2": [
                { "type": "field_number", "name": "UPDATE_RATE", "value": 30, "min": 0 }
                ],
                "message3": "Camera Name: %1",
                "args3": [
                { "type": "field_input", "name": "CAMERA_NAME", "text": "my_camera" }
                ],
                "message4": "Image Topic: %1",
                "args4": [
                { "type": "field_input", "name": "IMAGE_TOPIC", "text": "image_raw" }
                ],
                "message5": "Info Topic: %1",
                "args5": [
                { "type": "field_input", "name": "INFO_TOPIC", "text": "camera_info" }
                ],
                "message6": "Always On: %1",
                "args6": [
                { "type": "field_checkbox", "name": "ALWAYS_ON", "checked": true }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 160,
                "tooltip": "Adds a Gazebo camera plugin (with sensor) to the URDF",
                "helpUrl": "",
                "inputsInline": false
            },
        ]);
    
        // ÏΩîÎìú ÏÉùÏÑ±Í∏∞ Ìï®Ïàò Ï†ïÏùò
        Blockly.JavaScript['start'] = function(block) {
            return ''; // Îπà Î¨∏ÏûêÏó¥ÏùÑ Î∞òÌôòÌïòÏó¨ Ï∂îÍ∞ÄÏ†ÅÏù∏ ÏΩîÎìú ÏÉùÏÑ±ÏùÑ ÎßâÏùå
        };

    
        Blockly.JavaScript['material'] = function(block) {
            var r = block.getFieldValue('R');
            var g = block.getFieldValue('G');
            var b = block.getFieldValue('B');
            var a = block.getFieldValue('A');
            var code = `<material name="color">
        <color rgba="${r} ${g} ${b} ${a}"/>
        </material>
        `;
            return code;
        };
    
        Blockly.JavaScript['limit'] = function(block) {
            var lower = block.getFieldValue('LOWER');
            var upper = block.getFieldValue('UPPER');
            var effort = block.getFieldValue('EFFORT');
            var velocity = block.getFieldValue('VELOCITY');
            var code = `<limit lower="${lower}" upper="${upper}" effort="${effort}" velocity="${velocity}"/>
        `;
            return code;
        };
    
        Blockly.JavaScript['origin'] = function(block) {
            var x = block.getFieldValue('X');
            var y = block.getFieldValue('Y');
            var z = block.getFieldValue('Z');
            var r = block.getFieldValue('R');
            var p = block.getFieldValue('P');
            var yaw = block.getFieldValue('YAW');
            var code = `<origin xyz="${x} ${y} ${z}" rpy="${r} ${p} ${yaw}"/>
        `;
            return code;
        };
    
        Blockly.JavaScript['axis'] = function(block) {
            var x = block.getFieldValue('X');
            var y = block.getFieldValue('Y');
            var z = block.getFieldValue('Z');
            var code = `<axis xyz="${x} ${y} ${z}"/>
        `;
            return code;
        };
    
        Blockly.JavaScript['world_link'] = function(block) {
            var link_name = block.getFieldValue('LINK_NAME');
            var code = `<link name="${link_name}">
        </link>
        `;
            return code;
        };
    
        Blockly.JavaScript['link'] = function(block) {
            var link_name = block.getFieldValue('LINK_NAME');
            var statements_shape = Blockly.JavaScript.statementToCode(block, 'SHAPE');
            var code = `<link name="${link_name}">
        <visual>
            ${statements_shape}
        </visual>
        <collision>
            ${statements_shape}
        </collision>
        <inertial>
            <mass value="1.0"/>
            <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
        </inertial>
    </link>
    `;
            return code;
        };
    
        Blockly.JavaScript['joint'] = function(block) {
            var parent = block.getFieldValue('PARENT_LINK');
            var child = block.getFieldValue('CHILD_LINK');
            var joint_type = block.getFieldValue('JOINT_TYPE');
            var statements_elements = Blockly.JavaScript.statementToCode(block, 'JOINT_ELEMENTS');
            var code = `<joint name="${parent}_to_${child}" type="${joint_type}">
        <parent link="${parent}"/>
        <child link="${child}"/>
        ${statements_elements}
    </joint>
    `;
            return code;
        };
    
        Blockly.JavaScript['box'] = function(block) {
            var length = block.getFieldValue('LENGTH');
            var width = block.getFieldValue('WIDTH');
            var height = block.getFieldValue('HEIGHT');
            var code = `<geometry>
            <box size="${length} ${width} ${height}"/>
        </geometry>
    `;
            return code;
        };
    
        Blockly.JavaScript['sphere'] = function(block) {
            var radius = block.getFieldValue('RADIUS');
            var code = `<geometry>
        <sphere radius="${radius}"/>
    </geometry>
    `;
            return code;
        };
    
        Blockly.JavaScript['cylinder'] = function(block) {
            var radius = block.getFieldValue('RADIUS');
            var height = block.getFieldValue('HEIGHT');
            // ÏõêÌÜµÏùÑ yÏ∂ï Ï§ëÏã¨ÏúºÎ°ú ÌöåÏ†ÑÌïòÎèÑÎ°ù ÌïòÍ∏∞ ÏúÑÌï¥ rpyÎ•º Ï†ÅÏö©
            var code = `<geometry>
                <cylinder radius="${radius}" length="${height}"/>
            </geometry>
            <origin rpy="1.5708 0 0"/>`;
            return code;
        };

        Blockly.JavaScript['controller'] = function(block) {
            var name = block.getFieldValue('CONTROLLER_NAME');
            var type = block.getFieldValue('CONTROLLER_TYPE');
            var joints = Blockly.JavaScript.statementToCode(block, 'JOINTS').trim();

            // Store controller info for YAML generation
            if (!window.controllers) window.controllers = [];
            window.controllers.push({ name, type, joints: joints.split(',').map(j => j.trim()) });

            // Return empty string as we handle code generation separately
            return '';
        };


        Blockly.JavaScript['controller_parameters'] = function(block) {
            var controllerName = block.getFieldValue('CONTROLLER_NAME');
            var samplingTime = block.getFieldValue('SAMPLING_TIME');
            var pGain = block.getFieldValue('P_GAIN');
            var iGain = block.getFieldValue('I_GAIN');
            var dGain = block.getFieldValue('D_GAIN');
            var updateRate = block.getFieldValue('UPDATE_RATE');
            
            var code = `    ${controllerName}:
            parameters:
                sampling_time: ${samplingTime}
                pid: {p: ${pGain}, i: ${iGain}, d: ${dGain}}
                update_rate: ${updateRate}\n`;
            return code;
        };


        Blockly.JavaScript['joint_list'] = function(block) {
            var jointName = block.getFieldValue('JOINT_NAME');
            var code = `<joint name="${jointName}"/>\n`;
            return code;
        };

        Blockly.JavaScript['hardware_interface'] = function(block) {
            var hardwareName = block.getFieldValue('HARDWARE_NAME');
            var interfaceType = block.getFieldValue('INTERFACE_TYPE');
            var driverName = block.getFieldValue('DRIVER_NAME');
            
            var code = `hardware_interface:
        ros__parameters:
            ${hardwareName}:
            type: ${interfaceType}
            driver: ${driverName}\n`;
            return code;
        };

        Blockly.JavaScript['transmission'] = function(block) {
            var transmissionName = block.getFieldValue('TRANSMISSION_NAME');
            var jointName = block.getFieldValue('JOINT_NAME');
            var mechanicalReduction = block.getFieldValue('MECHANICAL_REDUCTION');
            
            var code = `transmission:
        - name: ${transmissionName}
            type: transmission_interface/SimpleTransmission
            joints:
            - name: ${jointName}
                hardwareInterface: PositionJointInterface
            actuators:
            - name: ${transmissionName}_actuator
                mechanicalReduction: ${mechanicalReduction}\n`;
            return code;
        };

        Blockly.JavaScript['joint_limits'] = function(block) {
            var jointName = block.getFieldValue('JOINT_NAME');
            var lower = block.getFieldValue('LOWER');
            var upper = block.getFieldValue('UPPER');
            var effort = block.getFieldValue('EFFORT');
            var velocity = block.getFieldValue('VELOCITY');
            
            var code = `joint_limits_interface:
        ros__parameters:
            ${jointName}:
            lower: ${lower}
            upper: ${upper}
            effort: ${effort}
            velocity: ${velocity}\n`;
            return code;
        };

        Blockly.JavaScript['joint_list'] = function(block) {
            var jointName = block.getFieldValue('JOINT_NAME');
            var code = `'${jointName}', `;
            return code;
        };

        Blockly.JavaScript['camera_plugin'] = function(block) {
            var pluginName = block.getFieldValue('PLUGIN_NAME');
            var updateRate = block.getFieldValue('UPDATE_RATE');
            var cameraName = block.getFieldValue('CAMERA_NAME');
            var imageTopic = block.getFieldValue('IMAGE_TOPIC');
            var infoTopic = block.getFieldValue('INFO_TOPIC');
            var alwaysOn = block.getFieldValue('ALWAYS_ON') === 'TRUE' ? 'true' : 'false';

            var code = `<gazebo reference="camera_link">
            <sensor name="camera_sensor" type="camera">
                <pose>0 0 0 0 0 0</pose>
                <visualize>true</visualize>
                <update_rate>${updateRate}</update_rate>
                <camera>
                <horizontal_fov>1.089</horizontal_fov>
                <image>
                    <width>640</width>
                    <height>480</height>
                    <format>R8G8B8</format>
                </image>
                <clip>
                    <near>0.05</near>
                    <far>8.0</far>
                </clip>
                </camera>
                <plugin name="${pluginName}" filename="libgazebo_ros_camera.so">
                <camera_name>${cameraName}</camera_name>
                <image_topic_name>${imageTopic}</image_topic_name>
                <camera_info_topic_name>${infoTopic}</camera_info_topic_name>
                <frame_name>camera_link</frame_name>
                </plugin>
            </sensor>
            </gazebo>
            `;
            return code;
            };

    function updateCode() {
        let code = `<!-- URDF File Generated by Blockly -->
<robot name="GeneratedRobot">
    `;
        code += Blockly.JavaScript.workspaceToCode(workspace);
        code += `</robot>`;
        document.getElementById('codeDiv').textContent = code;
        window.savedURDFCode = code;
        console.log("Generated URDF Code:", window.savedURDFCode);
    }

    workspace.addChangeListener(updateCode);

    function showCode() {
        document.getElementById('codeContainer').style.display = 'block';
    }

    function closeCode() {
        document.getElementById('codeContainer').style.display = 'none';
    }

    function renderURDF() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.urdf,.zip';

        input.onchange = event => {
            const file = event.target.files[0];
            if (file) {
                if (file.name.endsWith('.zip')) {
                    JSZip.loadAsync(file).then(zip => {
                        const urdfFile = Object.keys(zip.files).find(name => name.endsWith('.urdf'));
                        if (urdfFile) {
                            zip.file(urdfFile).async('text').then(urdfText => {
                                console.log("Loaded URDF from ZIP:", urdfText);
                            });
                        } else {
                            alert('ZIP ÌååÏùº ÎÇ¥Ïóê URDF ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.');
                        }
                    }).catch(error => {
                        console.error('ZIP ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò:', error);
                        alert('ZIP ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    });
                } else if (file.name.endsWith('.urdf')) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        console.log("Loaded URDF:", reader.result);
                    };
                    reader.readAsText(file);
                } else {
                    alert('URDF ÎòêÎäî ZIP ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
                }
            }
        };

        input.click();
    };

    function sendURDFToSimulation() {
    const urdfCode = window.savedURDFCode || '';
    if (!urdfCode) {
        alert('Î®ºÏ†Ä Î∏îÎ°ùÏùÑ Ï°∞Ìï©ÌïòÏó¨ URDF ÏΩîÎìúÎ•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.');
        return;
    }

    if (window.simulationWindow && !window.simulationWindow.closed) {
        window.simulationWindow.close();
    }

    window.simulationWindow = window.open('simulation.html', 'simulationWindow', 'width=800,height=600');

    function receiveMessage(event) {
        if (event.data && event.data.type === 'simulationReady') {
            window.removeEventListener('message', receiveMessage);
            window.simulationWindow.postMessage({ type: 'loadURDF', urdf: urdfCode }, '*');
        }
    }

    window.addEventListener('message', receiveMessage);
}

    function exportToROS() {
        const timestamp = new Date().toISOString().replace(/[-:.]/g, "");
        const urdfFileName = `robot_${timestamp}.urdf`;
        
        const urdfCode = window.savedURDFCode || '<robot name="GeneratedRobot"></robot>';
        
        const blob = new Blob([urdfCode], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = urdfFileName;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(link.href), 100);
    }


    function generateGazeboLaunchCode(urdfFileName) {
        return `#!/usr/bin/env python3

    import os
    from launch import LaunchDescription
    from launch_ros.actions import Node
    from launch.actions import ExecuteProcess
    from ament_index_python.packages import get_package_share_directory

    def generate_launch_description():
        # URDF ÌååÏùº Í≤ΩÎ°ú ÏÑ§Ï†ï
        urdf_file = os.path.join(
            get_package_share_directory('stem_keens_pkg'),
            'urdf',
            '${urdfFileName}'
        )
        
        # Gazebo Ïã§Ìñâ
        gazebo_launch = ExecuteProcess(
            cmd=['gazebo', '--verbose', '-s', 'libgazebo_ros_factory.so'],
            output='screen'
        )
        
        # Spawn Entity Node
        spawn_entity = Node(
            package='gazebo_ros',
            executable='spawn_entity.py',
            arguments=['-entity', 'robot', '-file', urdf_file],
            output='screen'
        )
        
        # Robot State Publisher
        rsp_node = Node(
            package='robot_state_publisher',
            executable='robot_state_publisher',
            arguments=[urdf_file],
            output='screen'
        )
        
        return LaunchDescription([
            gazebo_launch,
            spawn_entity,
            rsp_node,
        ])
    `;
    }


    function generateRViz2LaunchCode(urdfFileName) {
        return `#!/usr/bin/env python3

    import os
    from launch import LaunchDescription
    from launch_ros.actions import Node
    from ament_index_python.packages import get_package_share_directory

    def generate_launch_description():
        urdf_path = os.path.join(
            get_package_share_directory('stem_keens_pkg'),
            'urdf',
            '${urdfFileName}'
        )

        return LaunchDescription([
            Node(
                package='robot_state_publisher',
                executable='robot_state_publisher',
                output='screen',
                arguments=[urdf_path]
            ),
            Node(
                package='joint_state_publisher_gui',
                executable='joint_state_publisher_gui',
                name='joint_state_publisher_gui',
                output='screen'
            ),
            Node(
                package='rviz2',
                executable='rviz2',
                name='rviz2',
                output='screen'
            ),
        ])
    `;
    }


    function containsROS2ControlBlocks() {
        const blocks = workspace.getAllBlocks(false);
        return blocks.some(block => block.type.includes('controller') || block.type.includes('ros2_control'));
    }

    function generateYAMLConfig() {
        return `robot:
    ros__parameters:
        joints:
        # Joint configuration goes here
        controllers:
        # Controller configuration goes here
    `;
    }

    function generatePackageXML() {
        return `<?xml version="1.0"?>
    <package format="3">
    <name>stem_keens_pkg</name>
    <version>0.0.0</version>
    <description>Generated package from Stemkeens Rosblockly</description>
    <maintainer email="hoonle135@gmail.com">stem_keens</maintainer>
    <license>Apache License 2.0</license>
    <buildtool_depend>ament_cmake</buildtool_depend>
    <depend>rclpy</depend>
    <depend>urdf</depend>
    <depend>xacro</depend>
    <depend>rviz2</depend>
    <depend>ros2_control</depend>
    </package>
    `;
    }
    function generateCMakeLists() {
    return `cmake_minimum_required(VERSION 3.5)
    project(stem_keens_pkg)

    find_package(ament_cmake REQUIRED)
    find_package(rclpy REQUIRED)
    find_package(urdf REQUIRED)
    find_package(xacro REQUIRED)
    find_package(rviz2 REQUIRED)
    find_package(ros2_control REQUIRED)

    install(DIRECTORY launch urdf config worlds
    DESTINATION share/\${PROJECT_NAME}/
    )

    ament_package()
    `;
    }


    window.exportToROS = exportToROS;
    window.showCode = showCode;
    window.closeCode = closeCode;
    window.sendURDFToSimulation = sendURDFToSimulation;

    </script>    
</body>
</html>
